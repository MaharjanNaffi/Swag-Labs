name: Cypress Tests with Mochawesome Reporter

on:
  push:
    branches: ["main", "develop"]
  pull_request:
    branches: ["main", "develop"]
  schedule:
    - cron: "0 6 * * *" # Daily at 6:00 AM UTC
  workflow_dispatch: # Manual trigger

permissions:
  contents: write
  pull-requests: write
  checks: write

jobs:
  cypress-tests:
    runs-on: ubuntu-latest
    
    strategy:
      fail-fast: false
      matrix:
        browser: [chrome]

    steps:
      - name: ğŸ“¥ Checkout Code
        uses: actions/checkout@v4

      - name: ğŸŸ¢ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: npm

      - name: ğŸ“¦ Install Dependencies
        run: npm ci

      - name: ğŸ§ª Run Cypress Tests
        run: npm run cy:run
        env:
          CYPRESS_BASE_URL: ${{ secrets.CYPRESS_BASE_URL }}
          CYPRESS_USERNAME: ${{ secrets.CYPRESS_USERNAME }}
          CYPRESS_PASSWORD: ${{ secrets.CYPRESS_PASSWORD }}
        continue-on-error: true

      - name: ğŸ“Š Upload Test Report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: cypress-report-${{ matrix.browser }}-${{ github.run_number }}
          path: cypress/reports/
          retention-days: 30

      - name: ğŸ“Š Parse Test Results
        if: always()
        id: test_results
        run: |
          # Extract test stats from index.html
          TOTAL_TESTS=$(grep -oP '(?<="tests":\s)\d+' cypress/reports/index.html | head -1 || echo "0")
          PASSED_TESTS=$(grep -oP '(?<="passes":\s)\d+' cypress/reports/index.html | head -1 || echo "0")
          FAILED_TESTS=$(grep -oP '(?<="failures":\s)\d+' cypress/reports/index.html | head -1 || echo "0")
          DURATION=$(grep -oP '(?<="duration":\s)\d+' cypress/reports/index.html | head -1 || echo "0")
          
          echo "TOTAL_TESTS=$TOTAL_TESTS" >> $GITHUB_OUTPUT
          echo "PASSED_TESTS=$PASSED_TESTS" >> $GITHUB_OUTPUT
          echo "FAILED_TESTS=$FAILED_TESTS" >> $GITHUB_OUTPUT
          echo "DURATION=$DURATION" >> $GITHUB_OUTPUT
          
          # Calculate pass percentage
          if [ "$TOTAL_TESTS" -gt 0 ]; then
            PASS_PERCENT=$((PASSED_TESTS * 100 / TOTAL_TESTS))
          else
            PASS_PERCENT=0
          fi
          echo "PASS_PERCENT=$PASS_PERCENT" >> $GITHUB_OUTPUT
        continue-on-error: true

      - name: ğŸ“§ Send Email Report
        if: always()
        uses: dawidd6/action-send-mail@v3
        with:
          server_address: smtp.gmail.com
          server_port: 465
          username: ${{ secrets.EMAIL_USERNAME }}
          password: ${{ secrets.EMAIL_PASSWORD }}
          subject: "ğŸ§ª Cypress Test Report - Run #${{ github.run_number }} - ${{ job.status }}"
          body: |
            â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
                        CYPRESS AUTOMATED TEST REPORT
            â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
            
            ğŸ“Š TEST SUMMARY
            â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
            Total Tests:      ${{ steps.test_results.outputs.TOTAL_TESTS }}
            âœ… Passed:        ${{ steps.test_results.outputs.PASSED_TESTS }}
            âŒ Failed:        ${{ steps.test_results.outputs.FAILED_TESTS }}
            Success Rate:     ${{ steps.test_results.outputs.PASS_PERCENT }}%
            Duration:         ${{ steps.test_results.outputs.DURATION }}ms
            
            ğŸ“‹ EXECUTION DETAILS
            â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
            Workflow Run:     #${{ github.run_number }}
            Status:           ${{ job.status }}
            Branch:           ${{ github.ref_name }}
            Commit SHA:       ${{ github.sha }}
            Author:           ${{ github.actor }}
            Triggered By:     ${{ github.event_name }}
            
            ğŸ”— VIEW FULL REPORT
            â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
            Download the detailed HTML report from GitHub Actions Artifacts:
            
            Repository:       ${{ github.repository }}
            Run URL:          ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}
            
            ğŸ“¥ ARTIFACTS
            â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
            Artifact Name:    cypress-report-${{ matrix.browser }}-${{ github.run_number }}
            Retention:        30 days
            
            âœ¨ STATUS SUMMARY
            â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
            ${{ job.status == 'success' && 'âœ… All tests passed! The code is ready.' || 'âŒ Tests failed! Please review and fix the issues.' }}
            
            â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
            This is an automated email from GitHub Actions CI/CD Pipeline
            â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
          to: ${{ secrets.EMAIL_USERNAME }}
          from: ${{ secrets.EMAIL_USERNAME }}
        continue-on-error: true

      - name: ğŸ’¬ Comment PR with Test Results
        if: always() && github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const reportPath = 'cypress/reports/index.html';
            
            if (fs.existsSync(reportPath)) {
              github.rest.issues.createComment({
                issue_number: context.issue.number,
                owner: context.repo.owner,
                repo: context.repo.repo,
                body: `## ğŸ“Š Cypress Test Report\n\nâœ… Tests completed successfully!\n\nView the full report in [GitHub Actions Artifacts](${context.payload.pull_request.head.repo.html_url}/actions/runs/${context.runId})`
              });
            }
        continue-on-error: true

      - name: âŒ Close PR on Test Failure
        if: failure() && github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: 'âŒ Cypress tests failed. This PR is being closed automatically. Please review the test report and fix the issues.'
            });
            github.rest.pulls.update({
              pull_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              state: 'closed'
            });
        continue-on-error: true

      - name: âœ… Auto-Merge PR on Success
        if: success() && github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: 'âœ… All Cypress tests passed! Merging this PR automatically.'
            });
            github.rest.pulls.merge({
              pull_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              merge_method: 'merge'
            });
        continue-on-error: true
